<!-- src/app/pages/tipo-servicio/tipo-servicio.page.html -->

<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Tipos de servicio</ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="abrirModalCrear()">
        <ion-icon slot="icon-only" name="add-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Tipos de servicio</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Segmento Activos / Desactivados -->
  <ion-segment [(ngModel)]="segment" (ionChange)="onSegmentChange($event)" class="ion-padding-horizontal">
    <ion-segment-button value="activos">
      <ion-label>Activos</ion-label>
    </ion-segment-button>
    <ion-segment-button value="inactivos">
      <ion-label>Desactivados</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Filtros -->
  <ion-card class="ion-margin">
    <ion-card-header>
      <ion-card-title>Filtros</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-input
          label="Nombre"
          label-placement="stacked"
          placeholder="Buscar por nombre de tipo de servicio"
          [(ngModel)]="searchNombre">
        </ion-input>
      </ion-item>

      <ion-grid>
        <ion-row>
          <ion-col size="6">
            <ion-button expand="block" (click)="aplicarFiltros()">
              Buscar
            </ion-button>
          </ion-col>
          <ion-col size="6">
            <ion-button
              expand="block"
              fill="clear"
              color="medium"
              (click)="limpiarFiltros()">
              Limpiar
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <ion-progress-bar *ngIf="loading" type="indeterminate"></ion-progress-bar>

  <!-- Lista de Activos -->
  <ng-container *ngIf="segment === 'activos'">
    <ion-list *ngIf="tipoServiciosActivos.length; else noActivos" class="ion-margin-top">
      <ion-item *ngFor="let tipo of tipoServiciosActivos">
        <ion-label>
          <h2>{{ tipo.nombre }}</h2>
          <p>Servicios asociados: {{ tipo.servicios?.length || 0 }}</p>
        </ion-label>

        <ion-button fill="clear" (click)="abrirModalEditar(tipo)">
          <ion-icon slot="icon-only" name="create-outline"></ion-icon>
        </ion-button>

        <!-- Desactivar (soft delete) -->
        <ion-button
          fill="clear"
          color="danger"
          (click)="confirmarDesactivar(tipo)">
          <ion-icon slot="icon-only" name="close-circle-outline"></ion-icon>
        </ion-button>
      </ion-item>
    </ion-list>

    <ng-template #noActivos>
      <div class="ion-text-center ion-margin-top">
        <p>No hay tipos de servicio activos.</p>
      </div>
    </ng-template>
  </ng-container>

  <!-- Lista de Desactivados -->
  <ng-container *ngIf="segment === 'inactivos'">
    <ion-list *ngIf="tipoServiciosInactivos.length; else noInactivos" class="ion-margin-top">
      <ion-item *ngFor="let tipo of tipoServiciosInactivos">
        <ion-label>
          <h2>{{ tipo.nombre }}</h2>
          <p>Estado: Desactivado</p>
          <p>Servicios asociados: {{ tipo.servicios?.length || 0 }}</p>
        </ion-label>

        <!-- Reactivar -->
        <ion-button fill="clear" color="success" (click)="confirmarReactivar(tipo)">
          <ion-icon slot="icon-only" name="refresh-circle-outline"></ion-icon>
        </ion-button>
      </ion-item>
    </ion-list>

    <ng-template #noInactivos>
      <div class="ion-text-center ion-margin-top">
        <p>No hay tipos de servicio desactivados.</p>
      </div>
    </ng-template>
  </ng-container>

  <!-- Infinite scroll para el segmento actual -->
  <ion-infinite-scroll threshold="100px" (ionInfinite)="loadMore($event)">
    <ion-infinite-scroll-content
      loadingSpinner="bubbles"
      loadingText="Cargando mÃ¡s tipos de servicio...">
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>

  <!-- Modal Crear / Editar -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="cerrarModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>
            {{ modo === 'crear' ? 'Nuevo tipo de servicio' : 'Editar tipo de servicio' }}
          </ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarModal()">
              <ion-icon slot="icon-only" name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <form [formGroup]="tipoForm" (ngSubmit)="guardar()">
          <ion-item>
            <ion-label position="stacked">Nombre</ion-label>
            <ion-input
              formControlName="nombre"
              type="text"
              autocomplete="off">
            </ion-input>
          </ion-item>
          <ion-note
            color="danger"
            *ngIf="tipoForm.get('nombre')?.touched && tipoForm.get('nombre')?.invalid">
            El nombre es obligatorio.
          </ion-note>

          <div class="ion-margin-top ion-text-right">
            <ion-button type="button" fill="outline" (click)="cerrarModal()">
              Cancelar
            </ion-button>
            <ion-button type="submit">
              {{ modo === 'crear' ? 'Crear' : 'Guardar' }}
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
