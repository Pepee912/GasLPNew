<ion-header class="cliente-edit-header">
  <ion-toolbar class="cliente-edit-toolbar">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/clientes"></ion-back-button>
    </ion-buttons>
    <ion-title>Editar Cliente</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="cliente-edit-background">
  <div class="cliente-edit-wrapper">
    <div class="cliente-edit-card">

      <ng-container *ngIf="!loading; else skel">
        <!-- ======== FORM CLIENTE ======== -->
        <form [formGroup]="form" (ngSubmit)="onSubmit()">
          <div class="form-section-title">
            <h1>Datos del cliente</h1>
            <p>Actualiza la información básica y el estado del cliente.</p>
          </div>

          <ion-item class="form-item">
            <ion-input
              label="Nombre *"
              label-placement="floating"
              formControlName="nombre">
            </ion-input>
          </ion-item>
          <ion-note
            color="danger"
            class="form-error"
            *ngIf="form.controls.nombre.touched && form.controls.nombre.invalid">
            Ingresa al menos 2 caracteres.
          </ion-note>

          <ion-item class="form-item">
            <ion-input
              label="Apellidos"
              label-placement="floating"
              formControlName="apellidos">
            </ion-input>
          </ion-item>

          <ion-item class="form-item">
            <ion-input
              label="Teléfono (10 dígitos) *"
              label-placement="floating"
              inputmode="numeric"
              formControlName="telefono">
            </ion-input>
          </ion-item>
          <ion-note
            color="danger"
            class="form-error"
            *ngIf="form.controls.telefono.touched && form.controls.telefono.invalid">
            Debe tener exactamente 10 dígitos.
          </ion-note>

          <ion-item lines="none" class="form-toggle-item">
            <ion-toggle formControlName="estado">Activo</ion-toggle>
          </ion-item>

          <ion-button
            type="submit"
            expand="block"
            class="form-submit-btn"
            [disabled]="saving || form.invalid">
            {{ saving ? 'Guardando...' : 'Guardar cambios' }}
          </ion-button>
        </form>

        <!-- ======== DOMICILIOS RELACIONADOS ======== -->
        <ion-card class="domicilios-card ion-margin-top">
          <ion-card-header>
            <ion-card-title>Domicilios del cliente</ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <ng-container *ngIf="!loadingDomicilios; else domSkel">

              <ion-item *ngIf="!domicilios.length" class="domicilios-empty">
                <ion-label color="medium">
                  Este cliente aún no tiene domicilios registrados.
                </ion-label>
              </ion-item>

              <ion-list *ngIf="domicilios.length" class="domicilios-list">
                <ion-item *ngFor="let d of domicilios" class="domicilio-item">
                  <ion-label>
                    <h2>{{ d.calle }} #{{ d.numero }}</h2>
                    <p>{{ d.colonia }}, CP: {{ d.cp }}</p>
                    <p *ngIf="d.referencia">Ref: {{ d.referencia }}</p>
                    <ion-badge [color]="d.estado ? 'success' : 'medium'">
                      {{ d.estado ? 'Activo' : 'Inactivo' }}
                    </ion-badge>
                    <p class="ion-text-wrap domicilio-id">
                      <small>docId: {{ d.documentId || '—' }}</small>
                    </p>
                  </ion-label>

                  <ion-button
                    fill="outline"
                    slot="end"
                    size="small"
                    class="domicilio-edit-btn"
                    (click)="abrirModalDomicilio(d)">
                    Editar
                  </ion-button>
                </ion-item>
              </ion-list>

            </ng-container>

            <ng-template #domSkel>
              <ion-list class="domicilios-skeleton-list">
                <ion-item *ngFor="let s of [1,2]" class="domicilios-skeleton-item">
                  <ion-skeleton-text [animated]="true" style="width: 90%"></ion-skeleton-text>
                </ion-item>
              </ion-list>
            </ng-template>
          </ion-card-content>
        </ion-card>

      </ng-container>

      <!-- skeleton principal mientras carga el cliente -->
      <ng-template #skel>
        <ion-list class="cliente-edit-skeleton-list">
          <ion-item *ngFor="let s of [1,2,3]" class="cliente-edit-skeleton-item">
            <ion-skeleton-text [animated]="true" style="width: 80%"></ion-skeleton-text>
          </ion-item>
        </ion-list>
      </ng-template>

    </div>
  </div>

  <!-- ======== MODAL EDITAR DOMICILIO ======== -->
  <ion-modal
    class="domicilio-modal"
    [isOpen]="domModalOpen"
    (didDismiss)="cerrarModalDomicilio()">
    <ng-template>
      <ion-header class="domicilio-modal-header">
        <ion-toolbar>
          <ion-title>Editar domicilio</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarModalDomicilio()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="domicilio-modal-content">
        <form [formGroup]="domForm" (ngSubmit)="guardarDomicilio()">

          <ion-item class="form-item">
            <ion-input
              label="Calle"
              label-placement="floating"
              formControlName="calle">
            </ion-input>
          </ion-item>

          <ion-item class="form-item">
            <ion-input
              label="Número"
              label-placement="floating"
              formControlName="numero">
            </ion-input>
          </ion-item>

          <ion-item class="form-item">
            <ion-input
              label="Colonia"
              label-placement="floating"
              formControlName="colonia">
            </ion-input>
          </ion-item>

          <ion-item class="form-item">
            <ion-input
              label="CP"
              label-placement="floating"
              inputmode="numeric"
              formControlName="cp">
            </ion-input>
          </ion-item>

          <ion-item class="form-item">
            <ion-textarea
              label="Referencia"
              label-placement="floating"
              formControlName="referencia">
            </ion-textarea>
          </ion-item>

          <ion-item lines="none" class="form-toggle-item">
            <ion-toggle formControlName="estado">Activo</ion-toggle>
          </ion-item>

          <ion-button
            expand="block"
            type="submit"
            class="form-submit-btn">
            Guardar domicilio
          </ion-button>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
