<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/clientes"></ion-back-button>
    </ion-buttons>
    <ion-title>Editar Cliente</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ng-container *ngIf="!loading; else skel">
    <!-- ======== FORM CLIENTE ======== -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <ion-item>
        <ion-input label="Nombre *" label-placement="floating" formControlName="nombre"></ion-input>
      </ion-item>
      <ion-note color="danger" *ngIf="form.controls.nombre.touched && form.controls.nombre.invalid">
        Ingresa al menos 2 caracteres.
      </ion-note>

      <ion-item>
        <ion-input label="Apellidos" label-placement="floating" formControlName="apellidos"></ion-input>
      </ion-item>

      <ion-item>
        <ion-input
          label="Teléfono (10 dígitos) *"
          label-placement="floating"
          inputmode="numeric"
          formControlName="telefono">
        </ion-input>
      </ion-item>
      <ion-note color="danger" *ngIf="form.controls.telefono.touched && form.controls.telefono.invalid">
        Debe tener exactamente 10 dígitos.
      </ion-note>

      <ion-item lines="none">
        <ion-toggle formControlName="estado">Activo</ion-toggle>
      </ion-item>

      <ion-button type="submit" expand="block" [disabled]="saving || form.invalid">
        {{ saving ? 'Guardando...' : 'Guardar cambios' }}
      </ion-button>
    </form>

    <!-- ======== DOMICILIOS RELACIONADOS ======== -->
    <ion-card class="ion-margin-top">
      <ion-card-header>
        <ion-card-title>Domicilios del cliente</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <ng-container *ngIf="!loadingDomicilios; else domSkel">

          <ion-item *ngIf="!domicilios.length">
            <ion-label color="medium">
              Este cliente aún no tiene domicilios registrados.
            </ion-label>
          </ion-item>

          <ion-list *ngIf="domicilios.length">
            <ion-item *ngFor="let d of domicilios">
              <ion-label>
                <h2>{{ d.calle }} #{{ d.numero }}</h2>
                <p>{{ d.colonia }}, CP: {{ d.cp }}</p>
                <p *ngIf="d.referencia">Ref: {{ d.referencia }}</p>
                <ion-badge [color]="d.estado ? 'success' : 'medium'">
                  {{ d.estado ? 'Activo' : 'Inactivo' }}
                </ion-badge>
                <p class="ion-text-wrap">
                  <small>docId: {{ d.documentId || '—' }}</small>
                </p>
              </ion-label>

              <ion-button fill="outline" slot="end" size="small" (click)="abrirModalDomicilio(d)">
                Editar
              </ion-button>
            </ion-item>
          </ion-list>

        </ng-container>

        <ng-template #domSkel>
          <ion-list>
            <ion-item *ngFor="let s of [1,2]">
              <ion-skeleton-text [animated]="true" style="width: 90%"></ion-skeleton-text>
            </ion-item>
          </ion-list>
        </ng-template>
      </ion-card-content>
    </ion-card>

  </ng-container>

  <ng-template #skel>
    <ion-list>
      <ion-item *ngFor="let s of [1,2,3]">
        <ion-skeleton-text [animated]="true" style="width: 80%"></ion-skeleton-text>
      </ion-item>
    </ion-list>
  </ng-template>

  <!-- ======== MODAL EDITAR DOMICILIO ======== -->
  <ion-modal [isOpen]="domModalOpen" (didDismiss)="cerrarModalDomicilio()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Editar domicilio</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarModalDomicilio()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <form [formGroup]="domForm" (ngSubmit)="guardarDomicilio()">
          <ion-item>
            <ion-input
              label="Calle"
              label-placement="floating"
              formControlName="calle">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              label="Número"
              label-placement="floating"
              formControlName="numero">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              label="Colonia"
              label-placement="floating"
              formControlName="colonia">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              label="CP"
              label-placement="floating"
              inputmode="numeric"
              formControlName="cp">
            </ion-input>
          </ion-item>

          <ion-item>
            <ion-textarea
              label="Referencia"
              label-placement="floating"
              formControlName="referencia">
            </ion-textarea>
          </ion-item>

          <ion-item lines="none">
            <ion-toggle formControlName="estado">Activo</ion-toggle>
          </ion-item>

          <ion-button
            expand="block"
            type="submit">
            Guardar domicilio
          </ion-button>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>
